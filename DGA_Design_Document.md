# 数据治理平台 (Data Governance Authority) 项目总体设计文档

## 1. 文档概述

### 1.1 项目背景

在金融科技业务中，数据资产规模增长极快。为解决**跨大数据生态平台（如 Cloudera/CDH, Hortonworks/HDP）**带来的平台间隔离，以及异构存储（HDFS, Hive, ClickHouse, StarRocks）导致的数据孤岛、口径不统一及合规风险，需构建一站式治理平台。

### 1.2 设计原则

*   **非侵入性**：治理逻辑与生产调度解耦。
*   **高可用性**：核心元数据层支持高并发检索。
*   **AI 赋能**：利用 LLM 实现元数据自动打标与 SQL 诊断。

## 2. 总体架构设计

系统采用典型的分层架构，确保数据流向清晰。

### 2.1 物理架构层

*   **计算引擎**：Spark (用于大规模元数据加工)、Flink (用于实时质量监控)。
*   **存储引擎**：
    *   Graph DB (NebulaGraph/JanusGraph): 存储复杂的血缘关系图。
    *   Elasticsearch: 支撑资产目录的全文索引。
    *   PostgreSQL/MySQL: 存储基础配置与审计日志。

### 2.2 逻辑架构层

*   **采集层 (Ingestion)**：通过 Canal 监听 Binlog 或通过 JDBC 扫描数据源，获取 DDL 变更。
*   **引擎层 (Internal Engine)**：SQL 解析引擎（基于 Antlr4）、血缘追踪算法、代价模型估算。
*   **应用层 (API/UI)**：提供资产地图、质量仪表盘、成本账单等功能。
*   **模块开发（后端）**：采用 Java Spring Boot 框架，提供高性能的 RESTful API 接口，处理复杂的业务逻辑、调度控制与元数据查询。
*   **页面开发（前端）**：采用主流的 Vue.js 框架，配合 Ant Design 等企业级组件库，实现 Web UI 界面，确保用户体验和开发效率。

## 3. 核心功能模块详细设计

### 3.1 智能元数据管理 (Smart Metadata)

*   **技术元数据**：表名、字段名、存储位置、生命周期、JDK 版本等。
*   **业务元数据**：业务域、数据所有人、指标口径、关联需求文档。
*   **血缘追踪**：
    *   **字段级血缘**：解析 `SELECT a + b AS c` 中的依赖关系。
    *   **临时表处理**：追踪 Spark Shuffle 过程中的临时状态。

### 3.2 全链路质量监控 (DQC Flow)

*   **监控点预置**：在 ETL 任务的 ODS->DWD 关键节点植入探针。
*   **异常熔断**：当发现交易金额出现负数或空值率 > 5% 时，通过调度系统（如 DolphinScheduler/Airflow）阻断下游任务，防止坏数据污染。

### 3.3 数据安全管理 (Security & Privacy)

*   **自动分类分级**：基于正则表达式或 BERT 模型，自动识别包含姓名、卡号的敏感字段，标注为 L3/L4 级别。
*   **审批流整合**：集成企业 LDAP，实现“权限申请-审批-自动开通-定期回收”闭环。

### 3.4 降本增效 (FinOps)

*   **僵尸表清理**：统计过去 90 天无访问（Read Count = 0）的表，推送清理建议。
*   **存储策略优化**：识别冷数据，自动下沉到 HDFS 的 ARCHIVE 存储策略。

## 4. 关键技术方案

### 4.1 基于 Antlr4 的 SQL 血缘解析

*   **流程**：SQL String -> Lexer -> Parser -> AST (抽象语法树) -> Relation Graph。
*   **挑战**：兼容 Spark SQL 的各种 UDF 和复杂嵌套子查询。

### 4.2 “治理 Agent” 创新点

*   **SQL 诊断助手**：在用户提交 Spark 任务前，由本地运行的小规模 LLM 扫描代码，识别是否存在 `SELECT *` 或 Cartesian Product（笛卡尔积）风险。
*   **自动注释生成**：扫描表结构，根据字段名和历史数据样本，自动补齐缺失的字段注释。

## 5. 接口与交互设计

*   **外部依赖**：需对接公司调度系统 API、IM 告警插件（钉钉/企业微信）。
*   **内部接口**：采用 RESTful 风格，核心资产查询延迟需控制在 200ms 以内。

## 6. 实施路线图 (Roadmap)

*   **阶段一 (基础期)**：统一元数据采集，上线数据地图（解决“找不到”）。
*   **阶段二 (规范期)**：上线 DQC 规则引擎，确立开发标准（解决“信不过”）。
*   **阶段三 (优化期)**：开启安全脱敏与成本监控（解决“不敢用、成本高”）。
*   **阶段四 (智能期)**：引入 AI Agent 辅助治理（结合研究生论文研究方向）。

## 7. 主流数据治理能力对标

### 7.1 主流数据治理平台能力概览

结合行业内主流数据治理产品（如 Collibra、Atlan、Cloudera SDX 以及基于 Apache Atlas/Ranger 的自研平台），普遍具备如下能力域：

*   **数据资产目录 / 数据地图**：面向业务和技术人员提供可搜索、可浏览的数据资产目录。
*   **统一元数据管理**：集中管理技术元数据、业务元数据、运维元数据，多源多环境统一视图。
*   **数据血缘与影响分析**：支持库/表/字段级血缘展示，辅助变更评估和影响分析。
*   **数据质量管理**：提供规则管理、监控任务、质量评分、质量报告等能力。
*   **权限与安全治理**：以数据为中心的访问控制、脱敏策略、合规审计（典型实现为 Ranger + LDAP）。
*   **数据标准与指标体系**：统一业务术语、代码集、原子指标和派生指标管理。
*   **数据服务与开放能力**：通过 API/服务目录对外提供标准化数据服务。
*   **审计与运营监控**：记录用户行为和策略变更，提供治理运营看板。

### 7.2 DGA 平台能力映射

在此总体设计中，DGA 平台与主流能力域的对应关系如下：

*   **数据地图**：承载资产目录能力，对接 Hive/StarRocks 等多源元数据，逐步对接 Atlas 搜索接口。
*   **统一元数据管理**：通过后端统一元数据采集模块，整合多个 Hive Metastore、StarRocks 等元数据源，写入统一元数据仓库。
*   **数据血缘与影响分析**：一期以表级血缘为主，二期结合 Atlas/SQL 解析实现字段级血缘和影响分析。
*   **数据质量中心**：围绕关键主题域构建质量规则库，支撑质量评分、告警与报表。
*   **权限与安全治理**：以 LDAP + Hive + Ranger 组合实现“用户创建 + 权限自动授权 + 定期回收”闭环。
*   **数据标准与指标管理**：建设数据标准库和指标库，支撑数据资产统一口径和复用。
*   **审计与运营**：记录元数据变更、授权操作、质量事件，提供治理运营报表。

## 8. 功能架构详细说明

### 8.1 数据地图与元数据中心

**建设目标**

*   为业务、开发、运维提供统一的数据资产“黄页”，提升“找数”效率。
*   从多个大数据平台（CDH/HDP 集群、Hive、StarRocks 等）统一汇聚元数据。

**核心能力**

*   多数据源注册与配置管理（包括 Hive Metastore、StarRocks 等）。
*   元数据采集任务管理：支持定时全量/增量采集，按数据源和库表维度管理。
*   统一元数据模型：规范库、表、字段、分区、存储、拥有者等属性。
*   搜索与筛选：支持按库表名、业务域、标签等条件快速检索。
*   资产详情页：展示基础信息、血缘、质量、权限、标准等关联信息。

**关键设计点**

*   采用统一的元数据采集接口和策略模式，便于扩展新的元数据源类型。
*   通过 Atlas 接口或自建解析能力逐步增强血缘、标签等高级元数据。

### 8.2 数据质量中心

**建设目标**

*   建立从 ODS/DWD/DWS/ADS 全链路的数据质量保障体系。
*   从“点状质量规则”升级为“主题域质量管理”。

**核心能力**

*   质量规则管理：支持多类型规则（空值、唯一性、范围、枚举、比对等）。
*   质量任务编排：支持与调度系统集成，在任务链路关键节点自动触发质量校验。
*   质量事件告警：与企业 IM 系统集成，将质量异常通过群机器人/工单系统推送。
*   质量评分与报表：面向主题域或数据集形成质量评分和趋势分析。

**关键设计点**

*   质量规则与元数据强关联，支持按表/字段/主题域配置。
*   质量结果写入统一仓库，供报表和质量看板使用。

### 8.3 安全与权限中心（基于 LDAP + Hive + Ranger）

**建设目标**

*   以数据为核心的访问控制，实现“按需、可审计”的权限管理。
*   打通“用户 → 角色 → 策略 → 数据库对象”的完整链路。

**核心能力**

*   用户与目录管理：通过 LDAP 维护用户、用户组、组织架构。
*   自动授权流程：
    *   接收前端自动授权申请（用户名、数据库、权限类型等）。
    *   如用户在 LDAP 不存在，则自动创建。
    *   调用 Hive/Ranger 接口为用户或用户组授予库/表级权限。
*   权限视图与自查：用户可查看自身已拥有的权限和到期时间。
*   定期回收：支持按策略定期回收长时间未使用或过期的权限。

**关键设计点**

*   配置化对接现有 LDAP、HiveServer2、Ranger 实例，避免对现网产生侵入。
*   预留对接企业统一身份认证（SSO）的能力。

### 8.4 数据标准与指标中心

**建设目标**

*   统一业务术语和指标口径，解决“各说各话”的问题。

**核心能力**

*   业务术语管理：维护业务术语、定义、所属域、负责人。
*   代码集管理：维护统一代码表，如证件类型、地区、行业分类等。
*   指标体系：划分原子指标、派生指标、复合指标，记录计算口径和使用场景。
*   标准与资产关联：将标准和指标绑定到具体的库表和字段。

### 8.5 审计与运营监控中心

**核心能力**

*   审计日志：记录元数据变更、授权变更、质量事件、用户操作等。
*   治理运营看板：展示资产覆盖度、质量达标率、权限申请量、治理事项闭环率等关键指标。
*   报表导出：为管理层提供定期治理周报/月报。

## 9. 技术架构与实现方案（结合 DGA 实施）

### 9.1 前端技术架构

*   使用 **Vue2** 作为前端框架，配合 Vite 构建工具，提升开发与构建效率。
*   引入 Ant Design 等组件库，构建统一的企业级交互界面。
*   通过模块化路由拆分为：
    *   数据源管理与元数据采集配置模块。
    *   自动授权配置与申请模块。
    *   数据地图浏览与搜索模块（逐步建设）。
    *   质量规则与质量报表模块（后续迭代）。

### 9.2 后端技术架构

*   基础框架：Spring Boot 2.x，采用分层架构（Controller/Service/Repository/Domain）。
*   数据访问：Spring Data JPA + MySQL 存储元数据配置、质量规则、审计日志等。
*   目录服务：Spring LDAP 对接企业 LDAP，实现用户查询与创建。
*   大数据权限：通过 Hive JDBC/Ranger HTTP API 实现权限下发。
*   与外部系统的对接：
    *   Atlas：通过 REST API 获取或推送元数据、血缘和标签信息。
    *   Ranger：通过 REST API 管理访问策略，实现细粒度权限控制。

### 9.3 数据源与大数据平台集成

*   支持多套 Hive Metastore（适配 CDH/HDP 等不同发行版）。
*   支持扩展 StarRocks 等新型数仓引擎的元数据采集。
*   通过统一数据源配置表维护各环境的连接信息（JDBC URL、账号、方言等）。

### 9.4 与 Atlas 的集成设计（规划）

*   利用 Atlas 作为全局元数据和血缘服务：
    *   通过 Atlas API 获取 Hive/ETL 任务的血缘信息，在数据地图中展示。
    *   将 DGA 内部元数据变化按需推送回 Atlas，保持双向同步。
*   在 DGA UI 侧统一屏蔽底层差异，用户感知的是统一的数据地图和血缘视图。

### 9.5 与 Ranger 的集成设计（规划）

*   以 Ranger 为统一权限策略中心：
    *   通过 Ranger API 查询与管理 Hive 等组件的策略。
    *   DGA 自动授权模块负责将审批通过的授权请求转化为 Ranger 策略变更。
*   在 DGA 中展示权限视图和审计事件，形成从申请、审批、下发到审计的闭环。

## 10. 非功能性设计

### 10.1 性能与扩展性

*   元数据查询接口单次响应时间控制在 200ms 以内（常见查询场景）。
*   元数据采集任务支持按数据量水平扩展，通过分片和并发机制提升采集效率。
*   框架和存储选型支持后续分库分表、读写分离等扩展手段。

### 10.2 高可用与容错

*   关键服务支持多实例部署，通过负载均衡实现高可用。
*   采集和质量任务支持失败重试与补采机制，避免单次任务失败导致治理断点。

### 10.3 安全与合规

*   所有关键操作记录审计日志，满足监管与内审要求。
*   对接企业统一身份认证（SSO）和权限体系，避免帐号体系割裂。
*   支持对敏感数据的按角色脱敏和访问控制。

### 10.4 可运维性

*   提供运行状态、任务调度、失败重试等监控指标，接入企业监控告警系统。
*   通过配置中心管理多环境配置，支持灰度发布和回滚。
